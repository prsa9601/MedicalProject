@page
@using MedicalProject.Infrastructure.EnumUtil
@using MedicalProject.Infrastructure.Utils
@using MedicalProject.Models.User.Enum
@using System.Security.Claims
@model MedicalProject.Pages.Account.ProfileModel
@{
    ViewData["Title"] = "پروفایل من - پلتفرم دنگ";
}

<div class="min-h-screen bg-gray-50">
    <!-- Header -->
    <div class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <div class="flex-1">
                    <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 mb-2">پروفایل من</h1>
                    <p class="text-gray-600">مدیریت اطلاعات شخصی و حساب کاربری</p>
                </div>
             @*    <div class="flex items-center gap-3">
                    <button id="cancel-edit-btn"
                            class="btn btn-outline hidden">
                        <i class="fas fa-times ml-2"></i>
                        انصراف
                    </button>
                    <button id="save-btn"
                            type="button"
                            onclick="saveProfile()"
                            class="btn btn-primary hidden">
                        <i class="fas fa-save ml-2"></i>
                        ذخیره
                    </button>
                    <button id="edit-btn"
                            class="btn btn-primary">
                        <i class="fas fa-edit ml-2"></i>
                        ویرایش
                    </button>
                </div> *@
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Left Column - Main Content -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Personal Information Card -->
                <div class="card card-hover">
                    <div class="p-6">
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-gradient-to-br from-blue-600 to-blue-800 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-user text-white"></i>
                                </div>
                                <h2 class="text-xl font-bold text-gray-900">اطلاعات شخصی</h2>
                            </div>
                            <div class="badge @(Model.user.UserDocument?.Status == UserDocumentStatus.IsConfirmed ? "badge-success" : "badge-warning")">
                                <i class="fas @(Model.user.UserDocument?.Status == UserDocumentStatus.IsConfirmed ? "fa-check-circle" : "fa-clock") ml-1"></i>
                                @(Model.user.UserDocument?.Status.Map() ?? @UserDocumentStatus.NotConfirmed.Map())
                            </div>
                        </div>

                        <!-- فرم ویرایش پروفایل -->
                        <form id="profile-form" method="post" asp-page-handler="EditProfile">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <!-- First Name -->
                                <div>
                                    <label class="label">نام</label>
                                    <div class="relative">
                                        <input type="text"
                                               name="firstName"
                                               id="first-name"
                                               class="input pr-10"
                                               placeholder="نام"
                                               value="@Model.user.FirstName"
                                               disabled />
                                        <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                            <i class="fas fa-user text-gray-400"></i>
                                        </div>
                                    </div>
                                </div>

                                <!-- Last Name -->
                                <div>
                                    <label class="label">نام خانوادگی</label>
                                    <div class="relative">
                                        <input type="text"
                                               name="lastName"
                                               id="last-name"
                                               class="input pr-10"
                                               placeholder="نام خانوادگی"
                                               value="@Model.user.LastName"
                                               disabled />
                                        <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                            <i class="fas fa-user text-gray-400"></i>
                                        </div>
                                    </div>
                                </div>

                                <!-- Phone -->
                                <div>
                                    <label class="label">شماره تلفن</label>
                                    <div class="relative">
                                        <input type="tel"
                                               id="phone"
                                               class="input pr-10 dir-ltr"
                                               placeholder="شماره تلفن"
                                               value="@Model.user.PhoneNumber"
                                               disabled />
                                        <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                            <i class="fas fa-phone text-gray-400"></i>
                                        </div>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-1">شماره تلفن قابل تغییر نیست</p>
                                </div>
                            </div>
                            <!-- توکن CSRF -->
                            @Html.AntiForgeryToken()
                        </form>
                    </div>
                </div>

                <!-- KYC Section -->
                @{
                    if (Model.user.UserDocument == null || Model.user.UserDocument.Status == Models.User.Enum.UserDocumentStatus.NotConfirmed
                    || Model.user.UserDocument.Status == Models.User.Enum.UserDocumentStatus.WrongInformation)
                    {
                        <div class="card card-hover">
                            <div class="p-6">
                                <div class="flex items-center gap-3 mb-6">
                                    <div class="w-10 h-10 bg-gradient-to-br from-green-600 to-green-800 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-id-card text-white"></i>
                                    </div>
                                    <h2 class="text-xl font-bold text-gray-900">احراز هویت (KYC)</h2>
                                </div>

                                @if (Model.user.UserDocument != null)
                                {
                                    @if (Model.user.UserDocument.Status == Models.User.Enum.UserDocumentStatus.WrongInformation)
                                    {
                                        <div class="mb-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                                            <div class="flex items-start">
                                                <i class="fas fa-exclamation-triangle text-yellow-600 ml-2 mt-1"></i>
                                                <div>
                                                    <h4 class="text-yellow-800 font-semibold text-sm">توجه مهم</h4>
                                                    <p class="text-yellow-700 text-sm mt-1">
                                                        در صورت عدم دسترسی به کارت ملی، می‌توانید از گواهینامه رانندگی معتبر به جای آن استفاده کنید.
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                }

                                <form method="post" asp-page-handler="SendUserDocument" enctype="multipart/form-data" id="kyc-form">
                                    <div class="space-y-6">
                                        <!-- National Code -->
                                        <div>
                                            <label class="label">کد ملی</label>
                                            <div class="relative">
                                                <input type="text"
                                                       id="nationality-code"
                                                       name="nationalityCode"
                                                       class="input pr-10"
                                                       placeholder="کد ملی (10 رقم)"
                                                       maxlength="10"
                                                       pattern="\d{10}"
                                                       title="کد ملی باید 10 رقم باشد"
                                                       required />
                                                <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                                    <i class="fas fa-id-card text-gray-400"></i>
                                                </div>
                                            </div>
                                            <p class="text-xs text-gray-500 mt-1">کد ملی باید دقیقاً 10 رقم باشد</p>
                                        </div>

                                        <!-- National Card Image -->
                                        <div>
                                            <label class="label">تصویر کارت ملی</label>
                                            <div class="relative">
                                                <input type="file"
                                                       id="national-card-image"
                                                       name="nationalCardImage"
                                                       class="input pr-10 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
                                                       accept="image/*"
                                                       required />
                                                <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                                    <i class="fas fa-camera text-gray-400"></i>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Birth Certificate Image -->
                                        <div>
                                            <label class="label">تصویر شناسنامه</label>
                                            <div class="relative">
                                                <input type="file"
                                                       id="birth-certification-image"
                                                       name="birthCertificationImage"
                                                       class="input pr-10 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
                                                       accept="image/*"
                                                       required />
                                                <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                                    <i class="fas fa-camera text-gray-400"></i>
                                                </div>
                                            </div>
                                        </div>

                                        <button type="submit"
                                                id="upload-kyc-btn"
                                                class="btn btn-primary w-full">
                                            <i class="fas fa-cloud-upload-alt ml-2"></i>
                                            آپلود اسناد و ارسال برای تأیید
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    }
                }
            </div>

            <!-- Right Column - Sidebar -->
            <div class="space-y-6">
                <!-- Profile Summary -->
                <div class="card card-hover">
                    <div class="p-6">
                        <div class="text-center">
                            <div class="w-24 h-24 bg-gradient-to-br from-blue-600 to-blue-800 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fas fa-user text-white text-3xl"></i>
                            </div>
                            <h3 id="profile-name" class="text-xl font-bold text-gray-900 mb-2">
                                @Model.user.FirstName @Model.user.LastName
                            </h3>
                            <div class="mb-4">
                                <p id="profile-phone" class="text-gray-600 text-sm dir-ltr bg-gray-50 rounded-lg py-2 px-3 inline-block">
                                    <i class="fas fa-phone text-gray-400 ml-2"></i>
                                    @Model.user.PhoneNumber
                                </p>
                            </div>
                            <div class="mb-4">
                                <span id="profile-kyc-badge" class="badge @(Model.user.UserDocument?.Status == UserDocumentStatus.IsConfirmed ? "badge-success" : "badge-warning")">
                                    <i class="fas @(Model.user.UserDocument?.Status == UserDocumentStatus.IsConfirmed ? "fa-check-circle" : "fa-clock") ml-1"></i>
                                    @(Model.user.UserDocument?.Status.Map() ?? @UserDocumentStatus.NotConfirmed.Map())
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Account Information -->
                <div class="card card-hover">
                    <div class="p-6">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-8 h-8 bg-gradient-to-br from-purple-600 to-purple-800 rounded-lg flex items-center justify-center">
                                <i class="fas fa-info-circle text-white"></i>
                            </div>
                            <h3 class="text-lg font-bold text-gray-900">اطلاعات حساب</h3>
                        </div>

                        <div class="space-y-3">
                            <div class="flex justify-between items-center py-2 border-b border-gray-200">
                                <span class="text-gray-600">نقش</span>
                                <span class="badge badge-primary">@User.FindFirst(ClaimTypes.Role)?.Value</span>
                            </div>
                            <div class="flex justify-between items-center py-2 border-b border-gray-200">
                                <span class="text-gray-600">وضعیت KYC</span>
                                <span class="@(Model.user.UserDocument?.Status == UserDocumentStatus.IsConfirmed ? "text-green-600" : "text-yellow-600") font-semibold">
                                    @(Model.user.UserDocument?.Status.Map() ?? @UserDocumentStatus.NotConfirmed.Map())
                                </span>
                            </div>
                            @if (Model.user.CreationDate != default)
                            {
                                <div class="flex justify-between items-center py-2">
                                    <span class="text-gray-600">تاریخ عضویت</span>
                                    <span class="text-gray-900 font-medium">@Model.user.CreationDate.ToPersianDate()</span>
                                </div>
                            }
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="card card-hover">
                    <div class="p-6">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-8 h-8 bg-gradient-to-br from-green-600 to-green-800 rounded-lg flex items-center justify-center">
                                <i class="fas fa-bolt text-white"></i>
                            </div>
                            <h3 class="text-lg font-bold text-gray-900">دسترسی سریع</h3>
                        </div>

                        <div class="space-y-3">
                            <a href="/Account/Investment"
                               class="flex items-center justify-between p-3 bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors">
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-chart-line text-blue-600"></i>
                                    </div>
                                    <span class="text-gray-700">سرمایه‌گذاری‌های من</span>
                                </div>
                                <i class="fas fa-chevron-left text-gray-400"></i>
                            </a>

                            @{
                                if (Model.user.BankAccount == null)
                                {
                                    <a href="/Account/BankInformation"
                                       class="flex items-center justify-between p-3 bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors">
                                        <div class="flex items-center gap-3">
                                            <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center">
                                                <i class="fas fa-credit-card text-green-600"></i>
                                            </div>
                                            <span class="text-gray-700">ثبت اطلاعات حساب</span>
                                        </div>
                                        <i class="fas fa-chevron-left text-gray-400"></i>
                                    </a>
                                }
                                else if (Model.user.BankAccount.IsConfirmed == false)
                                {
                                    <a href="/Account/BankInformation"
                                       class="flex items-center justify-between p-3 bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors">
                                        <div class="flex items-center gap-3">
                                            <div class="w-8 h-8 bg-yellow-100 rounded-lg flex items-center justify-center">
                                                <i class="fas fa-edit text-yellow-600"></i>
                                            </div>
                                            <span class="text-gray-700">ویرایش اطلاعات حساب</span>
                                        </div>
                                        <i class="fas fa-chevron-left text-gray-400"></i>
                                    </a>
                                }
                                else
                                {
                                    <div class="flex items-center justify-between p-3 bg-green-50 rounded-lg">
                                        <div class="flex items-center gap-3">
                                            <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center">
                                                <i class="fas fa-check-circle text-green-600"></i>
                                            </div>
                                            <span class="text-green-700 font-medium">اطلاعات حساب تأیید شده</span>
                                        </div>
                                    </div>
                                }
                            }

                            <a href="/Front/Projects"
                               class="flex items-center justify-between p-3 bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors">
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-project-diagram text-purple-600"></i>
                                    </div>
                                    <span class="text-gray-700">پروژه‌های جدید</span>
                                </div>
                                <i class="fas fa-chevron-left text-gray-400"></i>
                            </a>

                            <a href="/Front/Notifications"
                               class="flex items-center justify-between p-3 bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors">
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 bg-orange-100 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-bell text-orange-600"></i>
                                    </div>
                                    <span class="text-gray-700">اعلان‌ها</span>
                                </div>
                                <i class="fas fa-chevron-left text-gray-400"></i>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* استایل‌های سفارشی برای صفحه پروفایل */
    .file\:mr-4 {
        margin-left: 1rem !important;
        margin-right: 0 !important;
    }

    .file\:bg-blue-50 {
        background-color: #eff6ff !important;
    }

    .file\:text-blue-700 {
        color: #1d4ed8 !important;
    }

    .file\:hover\:bg-blue-100:hover {
        background-color: #dbeafe !important;
    }

    /* استایل‌های خاص برای دکمه‌های فایل */
    input[type="file"]::-webkit-file-upload-button {
        border: none;
        border-radius: 9999px;
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
        font-weight: 600;
        background-color: #eff6ff;
        color: #1d4ed8;
        cursor: pointer;
        transition: background-color 0.2s;
    }

        input[type="file"]::-webkit-file-upload-button:hover {
            background-color: #dbeafe;
        }

    input[type="file"]::-moz-file-upload-button {
        border: none;
        border-radius: 9999px;
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
        font-weight: 600;
        background-color: #eff6ff;
        color: #1d4ed8;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    /* انیمیشن‌های سفارشی */
    .fade-in {
        animation: fadeIn 0.3s ease-in;
    }

    @@keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* استایل‌های برای نمایش وضعیت‌ها */
    .status-indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        display: inline-block;
        margin-left: 8px;
    }

    .status-active {
        background-color: #10b981;
    }

    .status-pending {
        background-color: #f59e0b;
    }

    .status-inactive {
        background-color: #9ca3af;
    }

    /* استایل‌های برای نمایش خطا */
    .input-error {
        border-color: #ef4444 !important;
        box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.1) !important;
    }

    .error-message {
        color: #ef4444;
        font-size: 0.875rem;
        margin-top: 0.25rem;
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    /* استایل‌های برای نمایش موفقیت */
    .success-message {
        color: #10b981;
        font-size: 0.875rem;
        margin-top: 0.25rem;
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    /* استایل‌های برای پیش‌نمایش تصویر */
    .image-preview {
        width: 100%;
        height: 200px;
        border: 2px dashed #d1d5db;
        border-radius: 0.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        margin-top: 0.5rem;
    }

        .image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

    /* استایل‌های برای دکمه‌های عمل */
    .action-buttons {
        display: flex;
        gap: 0.5rem;
    }

    .action-btn {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        padding: 0.75rem;
        border-radius: 0.5rem;
        border: 1px solid #d1d5db;
        background: white;
        color: #4b5563;
        cursor: pointer;
        transition: all 0.2s;
    }

        .action-btn:hover {
            background: #f9fafb;
            border-color: #9ca3af;
        }

        .action-btn.primary {
            background: #3b82f6;
            border-color: #3b82f6;
            color: white;
        }

            .action-btn.primary:hover {
                background: #2563eb;
            }

    /* استایل‌های برای نمایش بارگذاری */
    .loading-overlay {
        position: fixed;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(4px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
    }

    .loading-spinner {
        width: 3rem;
        height: 3rem;
        border: 3px solid #e5e7eb;
        border-top: 3px solid #3b82f6;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @@keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    /* رسپانسیو */
    @@media (max-width: 768px) {
        .grid-cols-2 {
            grid-template-columns: 1fr !important;
        }

        .flex-col-mobile {
            flex-direction: column !important;
        }

        .space-y-4-mobile > * + * {
            margin-top: 1rem !important;
        }
    }

    /* استایل‌های برای تاگل وضعیت */
    .status-toggle {
        display: inline-flex;
        align-items: center;
        background: #e5e7eb;
        border-radius: 9999px;
        padding: 0.25rem;
    }

    .status-toggle-btn {
        padding: 0.5rem 1rem;
        border-radius: 9999px;
        border: none;
        background: transparent;
        color: #6b7280;
        cursor: pointer;
        transition: all 0.2s;
    }

        .status-toggle-btn.active {
            background: white;
            color: #111827;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }

    /* استایل‌های برای تاریخ */
    .date-display {
        font-family: 'Vazir', monospace;
        direction: ltr;
    }

    /* استایل‌های برای تلفن */
    .phone-display {
        font-family: 'Vazir', monospace;
        direction: ltr;
    }
</style>

<script>
    // وضعیت ویرایش - false یعنی در حالت نمایش، true یعنی در حالت ویرایش
    let isEditing = false;

    // تابع تغییر حالت ویرایش
    function toggleEditMode() {
        isEditing = !isEditing;

        // فعال/غیرفعال کردن فیلدهای نام و نام خانوادگی
        const firstName = document.getElementById('first-name');
        const lastName = document.getElementById('last-name');

        if (firstName) firstName.disabled = !isEditing;
        if (lastName) lastName.disabled = !isEditing;

        // شماره تلفن همیشه غیرفعال باشد
        const phone = document.getElementById('phone');
        if (phone) phone.disabled = true;

        // به‌روزرسانی دکمه‌ها
        updateButtons();

        // اگر در حال خروج از حالت ویرایش هستیم، مقادیر را ریست کنیم
        if (!isEditing) {
            resetFormValues();
        }
    }

    // تابع بازنشانی مقادیر فرم
    function resetFormValues() {
        const firstName = document.getElementById('first-name');
        const lastName = document.getElementById('last-name');

        if (firstName) firstName.value = '@Model.user.FirstName';
        if (lastName) lastName.value = '@Model.user.LastName';
    }

    // تابع ذخیره پروفایل (ارسال به بک‌اند)
    function saveProfile() {
        const firstName = document.getElementById('first-name').value;
        const lastName = document.getElementById('last-name').value;

        // اعتبارسنجی
        if (!firstName.trim() || !lastName.trim()) {
            Alert.error('لطفاً نام و نام خانوادگی را وارد کنید', 'خطا');
            return;
        }

        // نمایش وضعیت ذخیره
        Alert.loading('در حال ذخیره اطلاعات...');

        // جمع‌آوری داده‌ها
        const formData = new FormData();
        formData.append('firstName', firstName);
        formData.append('lastName', lastName);

        // ارسال درخواست به بک‌اند
        fetch(window.location.pathname + '?handler=EditProfile', {
            method: 'POST',
            body: formData,
            headers: {
                'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
            }
        })
        .then(response => {
            if (response.redirected) {
                // اگر سرور redirect داده، به آن آدرس برو
                window.location.href = response.url;
                return Promise.resolve();
            }
            return response.text();
        })
        .then(data => {
            if (data) {
                try {
                    const result = JSON.parse(data);
                    if (result.success) {
                        // موفقیت آمیز
                        isEditing = false;
                        updateButtons();

                        // به‌روزرسانی نام در پروفایل
                        const profileName = document.getElementById('profile-name');
                        if (profileName) {
                            profileName.textContent = `${firstName} ${lastName}`;
                        }

                        // غیرفعال کردن فیلدها
                        document.getElementById('first-name').disabled = true;
                        document.getElementById('last-name').disabled = true;

                        Alert.close();
                        Alert.success('پروفایل با موفقیت به‌روزرسانی شد', 'موفقیت');
                    } else {
                        Alert.close();
                        Alert.error(result.message || 'خطا در ذخیره اطلاعات', 'خطا');
                    }
                } catch (e) {
                    Alert.close();
                    Alert.error('خطا در پردازش پاسخ سرور', 'خطا');
                }
            }
        })
        .catch(error => {
            Alert.close();
            Alert.error('خطا در ارتباط با سرور', 'خطا');
            console.error('Error:', error);
        });
    }

    // تابع به‌روزرسانی دکمه‌ها
    function updateButtons() {
        const editBtn = document.getElementById('edit-btn');
        const cancelBtn = document.getElementById('cancel-edit-btn');
        const saveBtn = document.getElementById('save-btn');

        if (editBtn && cancelBtn && saveBtn) {
            if (isEditing) {
                // حالت ویرایش
                editBtn.classList.add('hidden');
                cancelBtn.classList.remove('hidden');
                saveBtn.classList.remove('hidden');
            } else {
                // حالت نمایش
                editBtn.classList.remove('hidden');
                cancelBtn.classList.add('hidden');
                saveBtn.classList.add('hidden');
            }
        }
    }

    // تابع انصراف از ویرایش
    function cancelEdit() {
        isEditing = false;
        updateButtons();
        resetFormValues();

        // غیرفعال کردن فیلدها
        document.getElementById('first-name').disabled = true;
        document.getElementById('last-name').disabled = true;
    }

    // مقداردهی اولیه
    document.addEventListener('DOMContentLoaded', function() {
        // رویدادهای دکمه‌ها
        const editBtn = document.getElementById('edit-btn');
        const cancelBtn = document.getElementById('cancel-edit-btn');
        const saveBtn = document.getElementById('save-btn');

        if (editBtn) editBtn.addEventListener('click', toggleEditMode);
        if (cancelBtn) cancelBtn.addEventListener('click', cancelEdit);

        // ذخیره روی دکمه save در HTML تعریف شده

        // رویداد فرم KYC
        const kycForm = document.getElementById('kyc-form');
        if (kycForm) {
            kycForm.addEventListener('submit', function(event) {
                event.preventDefault();

                const nationalCode = document.getElementById('nationality-code');
                const nationalCard = document.getElementById('national-card-image');
                const birthCertificate = document.getElementById('birth-certification-image');

                // اعتبارسنجی کد ملی
                if (!/^\d{10}$/.test(nationalCode.value)) {
                    Alert.error('کد ملی وارد شده معتبر نیست', 'خطا');
                    return;
                }

                if (!nationalCard.files[0] || !birthCertificate.files[0]) {
                    Alert.error('لطفاً تمامی اسناد را انتخاب کنید', 'خطا');
                    return;
                }

                // نمایش وضعیت آپلود
                Alert.loading('در حال آپلود اسناد...');

                // ارسال فرم
                this.submit();
            });
        }

        // محدود کردن ورودی کد ملی به فقط اعداد
        const nationalityCode = document.getElementById('nationality-code');
        if (nationalityCode) {
            nationalityCode.addEventListener('input', function(e) {
                this.value = this.value.replace(/[^0-9]/g, '');
                if (this.value.length > 10) {
                    this.value = this.value.slice(0, 10);
                }
            });
        }

        // پیش‌نمایش تصاویر
        const fileInputs = document.querySelectorAll('input[type="file"]');
        fileInputs.forEach(input => {
            input.addEventListener('change', function(e) {
                const file = this.files[0];
                if (file) {
                    console.log('فایل انتخاب شد:', file.name);
                }
            });
        });

        // انیمیشن کارت‌ها
        const cards = document.querySelectorAll('.card');
        cards.forEach(card => {
            card.classList.add('fade-in');
        });

        // تنظیم وضعیت اولیه
        const phone = document.getElementById('phone');
        if (phone) {
            phone.disabled = true;
        }

        // تنظیم وضعیت اولیه دکمه‌ها
        updateButtons();
    });

    // تابع برای نمایش پیش‌نمایش تصویر
    function previewImage(input, previewId) {
        const preview = document.getElementById(previewId);
        if (!preview) return;

        const file = input.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                preview.innerHTML = `<img src="${e.target.result}" alt="پیش‌نمایش">`;
            };
            reader.readAsDataURL(file);
        } else {
            preview.innerHTML = '<i class="fas fa-image text-gray-400 text-4xl"></i>';
        }
    }

    // تابع اعتبارسنجی فرم
    function validateForm(formId) {
        const form = document.getElementById(formId);
        if (!form) return false;

        const inputs = form.querySelectorAll('input[required], select[required], textarea[required]');
        let isValid = true;

        inputs.forEach(input => {
            if (!input.value.trim()) {
                input.classList.add('input-error');
                isValid = false;
            } else {
                input.classList.remove('input-error');
            }
        });

        return isValid;
    }

    // تابع نمایش بارگذاری
    function showLoading() {
        const overlay = document.createElement('div');
        overlay.className = 'loading-overlay';
        overlay.innerHTML = '<div class="loading-spinner"></div>';
        document.body.appendChild(overlay);
    }

    // تابع پنهان کردن بارگذاری
    function hideLoading() {
        const overlay = document.querySelector('.loading-overlay');
        if (overlay) {
            overlay.remove();
        }
    }
</script>