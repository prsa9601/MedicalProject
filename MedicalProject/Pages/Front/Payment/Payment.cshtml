@page
@using MedicalProject.Infrastructure
@using MedicalProject.Infrastructure.Utils
@model MedicalProject.Pages.Front.Payment.PaymentModel
@{
    ViewData["Title"] = "نهایی کردن پرداخت";
}

@section Styles {
    <style>
        .payment-steps {
            display: flex;
            justify-content: center;
            margin-bottom: 3rem;
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #e5e7eb;
            color: #6b7280;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-bottom: 0.5rem;
            z-index: 2;
        }

        .step.active .step-number {
            background-color: #3b82f6;
            color: white;
        }

        .step.completed .step-number {
            background-color: #10b981;
            color: white;
        }

        .step-line {
            position: absolute;
            top: 20px;
            right: 50%;
            left: -50%;
            height: 2px;
            background-color: #e5e7eb;
            z-index: 1;
        }

        .step:first-child .step-line {
            display: none;
        }

        .step-text {
            font-size: 0.875rem;
            color: #6b7280;
        }

        .step.active .step-text {
            color: #3b82f6;
            font-weight: 600;
        }

        .payment-summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 1.5rem;
            box-shadow: 0 20px 40px rgba(102, 126, 234, 0.15);
        }

        .security-badge {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 2rem;
            font-size: 0.875rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .payment-method {
            transition: all 0.3s ease;
            border: 2px solid #e5e7eb;
        }

            .payment-method:hover {
                border-color: #3b82f6;
                transform: translateY(-2px);
            }

            .payment-method.selected {
                border-color: #3b82f6;
                background-color: #f8fafc;
            }

        .price-amount {
            font-feature-settings: 'tnum';
            font-variant-numeric: tabular-nums;
        }

        .bank-logo {
            filter: grayscale(100%);
            opacity: 0.7;
            transition: all 0.3s ease;
        }

            .bank-logo:hover {
                filter: grayscale(0%);
                opacity: 1;
            }
    </style>
}

<div class="min-h-screen bg-gradient-to-br from-gray-50 to-blue-50 py-8">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Payment Steps -->
        <div class="payment-steps">
           
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Column - Payment Methods -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Payment Methods -->
                <div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-8">
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">روش پرداخت</h2>
                    <p class="text-gray-600 mb-8">روش مورد نظر خود را برای پرداخت انتخاب کنید</p>

                    <div class="space-y-4">
                        <!-- Online Payment -->
                        <div class="payment-method selected border-2 border-blue-500 rounded-xl p-6 cursor-pointer">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-4 space-x-reverse">
                                    <div class="w-14 h-10 bg-gradient-to-r from-blue-500 to-purple-600 rounded-lg flex items-center justify-center shadow-lg">
                                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
                                        </svg>
                                    </div>
                                    <div>
                                        <div class="font-bold text-gray-900 text-lg">پرداخت آنلاین</div>
                                        <div class="text-gray-500 mt-1">پرداخت امن از طریق درگاه بانکی</div>
                                    </div>
                                </div>
                                <div class="w-6 h-6 rounded-full border-2 border-blue-500 flex items-center justify-center bg-blue-500">
                                    <svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                                    </svg>
                                </div>
                            </div>
                        </div>

                    </div>

                    <!-- Payment Details -->
                    <div class="mt-12 pt-8 border-t border-gray-200">
                        <h3 class="text-xl font-bold text-gray-900 mb-6">مشخصات پرداخت</h3>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 bg-gray-50 rounded-xl p-6">
                            <div class="space-y-4">
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600 font-medium">تاریخ سفارش</span>
                                    <span class="text-gray-900 font-semibold">@DateTime.Now.ToPersianDate()</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600 font-medium">وضعیت پرداخت</span>
                                    <span class="text-amber-600 font-semibold bg-amber-50 px-3 py-1 rounded-full text-sm">در انتظار پرداخت</span>
                                </div>
                            </div>
                            <div class="space-y-4">
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600 font-medium">روش پرداخت</span>
                                    <span class="text-gray-900 font-semibold">آنلاین</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600 font-medium">کد رهگیری</span>
                                    <span class="text-gray-400 font-medium">پس از پرداخت</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column - Order Summary -->
            <div class="space-y-6">
                <!-- Order Summary -->
                <div class="payment-summary-card p-8">
                    <h2 class="text-2xl font-bold text-white mb-8">خلاصه سفارش</h2>

                    <div class="space-y-6">
                        <!-- Product Info -->
                        <div class="flex items-center space-x-4 space-x-reverse pb-6 border-b border-blue-400 border-opacity-50">
                            @if (Model.Product != null && !string.IsNullOrEmpty(Model.Product.ImageName))
                            {
                                <img src="@Directories.GetProductImagePathPath(Model.Product.ImageName)"
                                     alt="@Model.Product.Title"
                                     class="w-20 h-20 rounded-xl object-cover shadow-lg" />
                            }
                            else
                            {
                                <div class="w-20 h-20 bg-white bg-opacity-20 rounded-xl flex items-center justify-center shadow-lg">
                                    <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                                    </svg>
                                </div>
                            }
                            <div class="flex-1">
                                <h3 class="font-bold text-white text-lg leading-tight">@(Model.Product?.Title ?? "محصول")</h3>
                                <p class="text-blue-100 text-sm mt-2">@Model.Product.InventoryDto.Dong.ToString("0.0") دانگ</p>
                            </div>
                        </div>

                        <!-- Price Breakdown -->
                        <div class="space-y-4">
                            <div class="flex justify-between items-center py-2">
                                <span class="text-blue-100 text-lg">قیمت هر دانگ</span>
                                <span class="text-white font-bold text-lg price-amount">
                                    @if (Model.Product?.InventoryDto != null)
                                    {
                                            decimal price2 = 0;
                                            decimal.TryParse(Model.Product?.InventoryDto?.PricePerDong, out price2);
                                        
                                        <span class="text-white">@price2.ToString("N0", new System.Globalization.CultureInfo("fa-IR"))</span>
                                    }
                                    else
                                    {
                                        <text>۰</text>
                                    }
                                    <span class="text-sm font-normal mr-1">ریال</span>
                                </span>
                            </div>

                            <div class="flex justify-between items-center py-2">
                                <span class="text-blue-100 text-lg">تعداد دانگ</span>
                                <span class="text-white font-bold text-lg">@Model.Product.InventoryDto.Dong.ToString("0.0")</span>
                            </div>

                            <div class="pt-4 border-t border-blue-400 border-opacity-50">
                                <div class="flex justify-between items-center">
                                    <span class="text-white text-xl font-bold">مبلغ قابل پرداخت</span>
                                    <span class="text-2xl font-bold text-white price-amount">
                                        @{
                                            decimal price = 0;
                                            decimal.TryParse(Model.Product?.InventoryDto?.PricePerDong, out price);
                                        }
                                        <span class="text-white">@price.ToString("N0", new System.Globalization.CultureInfo("fa-IR")) ریال</span>  
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="space-y-4">
                    <button id="confirmPayment" class="w-full bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white py-4 px-6 rounded-xl font-bold text-lg shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1 flex items-center justify-center">
                  @*       <svg class="w-6 h-6 ml-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                        </svg> *@
                        پرداخت
                    </button>

                    <a href="/Front/Projects/Details?slug=@Model.Product?.Slug" class="w-full bg-white text-gray-700 border-2 border-gray-300 hover:border-gray-400 py-3 px-6 rounded-xl font-semibold text-center block transition-all duration-300 hover:shadow-lg">
                        بازگشت به محصول
                    </a>
                </div>

                <!-- Security & Bank Logos -->
                <div class="text-center space-y-6">
                    <div class="flex justify-center space-x-8 space-x-reverse">
                        <img src="/images/saman-card.png" alt="سامان" class="h-10 bank-logo" title="بانک سامان">
                        <img src="/images/mellat-card.png" alt="ملت" class="h-10 bank-logo" title="بانک ملت">
                        <img src="/images/parsian-card.png" alt="پارسیان" class="h-10 bank-logo" title="بانک پارسیان">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div id="loadingModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden backdrop-blur-sm">
    <div class="bg-white rounded-2xl p-8 max-w-sm w-full mx-4 shadow-2xl">
        <div class="text-center">
            <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-600 mx-auto mb-6"></div>
            <h3 class="text-xl font-bold text-gray-900 mb-3">در حال اتصال به درگاه پرداخت</h3>
            <p class="text-gray-600">لطفاً چند لحظه صبر کنید...</p>
        </div>
    </div>
</div>

@functions {
    private string FormatPrice(decimal price)
    {
        return price.ToString("N0", new System.Globalization.CultureInfo("fa-IR"));
    }
}

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const paymentMethods = document.querySelectorAll('.payment-method');
            const confirmPaymentBtn = document.getElementById('confirmPayment');
            const loadingModal = document.getElementById('loadingModal');

            // Payment method selection
            paymentMethods.forEach(method => {
                method.addEventListener('click', function() {
                    paymentMethods.forEach(m => {
                        m.classList.remove('selected', 'border-blue-500', 'bg-gray-50');
                        m.querySelector('.bg-blue-500')?.classList.remove('bg-blue-500');
                        m.querySelector('.bg-blue-500')?.classList.add('border-gray-300');
                        const icon = m.querySelector('svg');
                        if (icon) {
                            icon.parentElement.innerHTML = '<div class="w-6 h-6 rounded-full border-2 border-gray-300"></div>';
                        }
                    });

                    this.classList.add('selected', 'border-blue-500', 'bg-gray-50');
                    const radioDiv = this.querySelector('.flex.items-center.justify-between > div:last-child');
                    if (radioDiv) {
                        radioDiv.innerHTML = `
                            <div class="w-6 h-6 rounded-full border-2 border-blue-500 flex items-center justify-center bg-blue-500">
                                <svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                                </svg>
                            </div>
                        `;
                    }
                });
            });

            // Confirm payment
            confirmPaymentBtn.addEventListener('click', function() {
                loadingModal.classList.remove('hidden');

                // Simulate payment process
                setTimeout(() => {
                    // In real scenario, redirect to bank gateway
                    window.location.href = '/Front/Payment/Success?orderId=@($"ORD-{DateTime.Now:yyyyMMdd-HHmmss}")';
                }, 2000);
            });

            // Initialize first payment method as selected
            if (paymentMethods.length > 0) {
                paymentMethods[0].click();
            }
        });
    </script>
}